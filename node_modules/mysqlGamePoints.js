/* Eduardo Oviedo Blanco
 * eduardo.oviedo@gmail.com
 * MySQL connection module
 */

var mysql = require('mysql');

var credentials = {};
if (process.env.VCAP_SERVICES) {
  var configuration = JSON.parse(process.env.VCAP_SERVICES);
  credentials = configuration['mysql-5.1'][0]['credentials'];
}else{
  console.log('No envioroment variable found, using local setings intead.');
  credentials.name = 'd5e249d99362c42d2b9521b01797919a5'
  credentials.host = '127.0.0.1';
  credentials.port = '10000';
  credentials.user = 'uTId1ii2kge39';
  credentials.password = 'p9xJZhOAiZtSU';
};

var connection = mysql.createConnection({
  database : credentials.name,
  host     : credentials.host,
  port     : credentials.port,
  user     : credentials.user,
  password : credentials.password
});

function handleDisconnect(connection) {
  connection.on('error', function(err) {
    if (!err.fatal) {
      return;
    }

    if (err.code !== 'PROTOCOL_CONNECTION_LOST') {
      throw err;
    }

    console.log('Re-connecting lost connection: ' + err.stack);

    connection = mysql.createConnection(connection.config);
    handleDisconnect(connection);
    connection.connect();
  });
};
handleDisconnect(connection);

exports.connection = connection;