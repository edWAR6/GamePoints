/* Eduardo Oviedo Blanco
 * eduardo.oviedo@gnastudio.net
 * MySQL connection module
 */

var mysql = require('mysql');
var pool;
var credentials = {};

if (process.env.VCAP_SERVICES) {
  var configuration = JSON.parse(process.env.VCAP_SERVICES);
  credentials = configuration['mysql-5.1'][0]['credentials'];
}else{
  console.log('No envioroment variable found, using local setings intead.');
  credentials.name = 'd5e249d99362c42d2b9521b01797919a5'
  credentials.host = '127.0.0.1';
  credentials.port = '10000';
  credentials.user = 'uaVW9MsRnsbjr';
  credentials.password = 'pmz1jfVbdTQBU';
};

pool = mysql.createPool({
  database        : credentials.name,
  host            : credentials.host,
  port            : credentials.port,
  user            : credentials.user,
  password        : credentials.password,
  connectionLimit : 1
});

exports.pool = pool;

// var connection = mysql.createConnection({
//   database : credentials.name,
//   host     : credentials.host,
//   port     : credentials.port,
//   user     : credentials.user,
//   password : credentials.password
// });

// function handleDisconnect(connection) {
//   connection.on('error', function(err) {
//     if (!err.fatal) {
//       return;
//     }

//     if (err.code !== 'PROTOCOL_CONNECTION_LOST') {
//       throw err;
//     }

//     console.log('Re-connecting lost connection: ' + err.stack);

//     connection = mysql.createConnection(connection.config);
//     handleDisconnect(connection);
//     connection.connect();
//   });
// };
// handleDisconnect(connection);

// exports.connection = connection;